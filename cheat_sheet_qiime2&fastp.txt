Vinyards analysis 10.10.23
Qiime2 for soil amplicons
#1- trimming using fastp
#2- merging using fastp

#3- preparing manifest file
echo -e 'sample-id\tabsolute-filepath' > manifest.tsv
for x in *.fq.gz ; do ID=$(basename $x | cut -f1 -d.); echo -e "${ID}\t${PWD}/${x}" >> manifest.tsv ; done

#4- Importing the sequencing reads
qiime tools import \
  --type 'SampleData[SequencesWithQuality]' \
  --input-path ./manifest_flash_filtered.tsv \
  --output-path demux.qza \
  --input-format SingleEndFastqManifestPhred33V2

#5- Denoising
 qiime dada2 denoise-single \
   --i-demultiplexed-seqs ./demux.qza \
   --p-trim-left 0 \
   --p-trunc-len 0 \
   --o-table table.qza \
   --p-n-threads 120 \
   --o-representative-sequences rep-seqs.qza \
   --o-denoising-stats denoising-stats.qza --verbose


iime dada2 denoise-paired \
--i-demultiplexed-seqs ../paired-end-demux.qza \
--p-trim-left-f 10 \
--p-trim-left-r 10 \
--p-trunc-len-f \
--p-trunc-len-r \
--p-n-threads 12 \
--o-table table.qza \
--o-representative-sequences rep-seqs.qza \
--o-denoising-stats denoising-stats.qza --verbose

qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file ../metadata.tsv

qiime feature-table tabulate-seqs \
  --i-data 16S_representative-sequences.qza \
  --o-visualization 16S_rep-seqs.qzv

qiime metadata tabulate \
  --m-input-file 16S_denoising-stats.qza \
  --o-visualization 16S_denoising-stats.qzv

#Generate a tree for phylogenetic diversity analyses
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences ./denoising/representative-sequences.qza \
  --p-n-threads 24 \
  --output-dir phylogeny-align-to-tree-mafft-fasttree 

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny ./rooted_tree.qza \
  --i-table ../denoising/table.qza \
  --p-n-jobs-or-threads 32 \
  --p-sampling-depth 1000 \
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --output-dir diversity-core-metrics-phylogenetic

#######################################################################################################
qiime diversity beta-group-significance \							
  --i-distance-matrix diversity-core-metrics-phylogenetic/bray_curtis_distance_matrix.qza \
  --m-metadata-file ../metadata_vineyards_16S_filtered.tsv \
  --m-metadata-column code_status\
  --p-pairwise \
  --o-visualization 16Sbray_curtis_distance_matrix_.qzv												      
#######################################################################################################

#Alpha diversity
qiime diversity alpha-group-significance \
  --i-alpha-diversity diversity-core-metrics-phylogenetic/faith_pd_vector.qza \
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --o-visualization faith-pd-group-significance_MT.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity diversity-core-metrics-phylogenetic/evenness_vector.qza \
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --o-visualization evenness-group-significance_MT.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity diversity-core-metrics-phylogenetic/shannon_vector.qza \
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --o-visualization shannon-group-significance_MT.qzv

#Beta diversity

qiime diversity beta-group-significance \
  --i-distance-matrix 
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --p-pairwise \
  --o-visualization bray_curtis_pcoa_results.qzv

##############################################

qiime emperor plot \
  --i-pcoa diversity-core-metrics-phylogenetic/bray_curtis_pcoa_results.qza \
  --m-metadata-file ../metadata_vineyards_16S_filtered.tsv \
  --p-custom-axes Zn \
  --o-visualization bray-curtis-emperor-pcoa-Zn.qzv

qiime emperor plot \
  --i-pcoa diversity-core-metrics-phylogenetic/unweighted_unifrac_pcoa_results.qza \
  --m-metadata-file ../metadata_vineyards_16S_filtered.tsv \
  --p-custom-axes Zn \
  --o-visualization unweighted_unifrac_pcoa_Zn.qzv

##################################################################
qiime diversity beta-group-significance \
  --i-distance-matrix diversity-core-metrics-phylogenetic/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --m-metadata-column varietystatus \
  --p-pairwise \
  --o-visualization 16S_unweighted-unifrac-varietystatus-significance.qzv

qiime diversity beta-group-significance \
  --i-distance-matrix diversity-core-metrics-phylogenetic/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file ../metadata_vineyards_MT.tsv \
  --m-metadata-column Plant-status \
  --p-pairwise \
  --o-visualization 16S_unweighted-unifrac-plant-status-significance.qzv


qiime diversity beta-group-significance \
  --i-distance-matrix diversity-core-metrics-phylogenetic/weighted_unifrac_distance_matrix.qza \
  --m-metadata-file ../metadata_vineyards_16S_filtered.tsv \
  --m-metadata-column variety \
  --p-pairwise \
  --o-visualization 16S_unweighted-unifrac-variety-significance.qzv

qiime diversity beta-group-significance \
  --i-distance-matrix diversity-core-metrics-phylogenetic/
  --m-metadata-column variety \
  --p-pairwise \
  --o-visualization 16S_unweighted-unifrac-variety-significance.qzv

qiime emperor plot \
  --i-pcoa 3-diversity-core-metrics-phylogenetic/ \
  --m-metadata-file ../metadata.tsv \
  --p-custom-axes days \
  --o-visualization unweighted-unifrac-emperor-days.qzv

qiime emperor plot \
  --i-pcoa 3-diversity-core-metrics-phylogenetic/bray_curtis_pcoa_results.qza \
  --m-metadata-file ../metadata.tsv \
  --p-custom-axes days \
  --o-visualization bray-curtis-emperor-emperor-days.qzv

qiime emperor plot \
  --i-pcoa core-metrics-phylogenetic/ \
  --m-metadata-file sample-metadata.tsv \
  --p-custom-axes days-since-experiment-start \
  --o-visualization core-metrics-results/-days-since-experiment-start.qzv


///////////////////////////////////////////////////////////////////////////////////////////////////////////////

qiime feature-classifier classify-sklearn \
  --i-classifier ./silva-138-99-nb-classifier.qza \
  --i-reads ../1_denoising/representative-sequences.qza \
  --p-n-jobs 16 \
  --o-classification flash_taxonomy.qza --verbose

qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization 16S_taxonomy.qzv


{{{{{{Filtering sequencing}}}}}}}}}
qiime taxa filter-table \
  --i-table ./1_denoising/16S_table.qza \
  --i-taxonomy ./2_taxonomy/taxonomy.qza \
  --p-exclude "cyano" --p-mode contains \
--o-filtered-table ./16S_table_filtered.qza

qiime taxa filter-table \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --p-include p__ \
  --p-exclude mitochondria,chloroplast,ascomycota \
  --o-filtered-table table-with-phyla-no-mitochondria-no-chloroplast.qza

qiime taxa barplot \
  --i-table ../denoising/table.qza \
  --i-taxonomy flash_taxonomy.qza \
  --m-metadata-file ../metadata_vineyards_16S_filtered.tsv \
  --o-visualization 16S_taxa-bar-plots_depth.qzv

///////////////////////////////////////////////////////////////////////flash////////////////////////////////////////////

#Generate a tree for phylogenetic diversity analyses
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences ./1_denoising/representative-sequences.qza \
  --p-n-threads 24 \
  --output-dir phylogeny-align-to-tree-mafft-fasttree 

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny ./rooted_tree.qza \
  --i-table ../1_denoising/table.qza \
  --p-n-jobs-or-threads 24 \
  --p-sampling-depth 6000 \
  --m-metadata-file ../metadata_vineyards.tsv \
  --output-dir diversity-core-metrics-phylogenetic

qiime feature-classifier classify-sklearn \
  --i-classifier ./silva-138-99-nb-classifier.qza \
  --i-reads ../1_denoising/representative-sequences.qza \
  --p-n-jobs 16 \
  --o-classification flash_taxonomy.qza --verbose

qiime taxa barplot \
  --i-table ../1_denoising/table.qza \
  --i-taxonomy flash_taxonomy.qza \
  --m-metadata-file ../metadata_vineyards.tsv \
  --o-visualization 16S_taxa-bar-plots_depth.qzv

qiime metadata tabulate \
  --m-input-file flash_taxonomy.qza \
  --o-visualization 16S_taxonomy.qzv

qiime taxa barplot \
  --i-table ../denoising/table.qza\
  --i-taxonomy taxonomy.qza \
  --m-metadata-file ../metadata_vineyards.tsv \
  --o-visualization 16S_filtered-bar-plots_depth.qzv



#taxanomic analysis

qiime feature-classifier classify-sklearn --i-reads ./denoising_representatives.qza --i-classifier ./silva-138-99-nb-classifier.qza --p-n-jobs 8 --o-classification taxonomy.qza

qiime tools export --input-path classified_reps.qza --output-path classification_table

qiime taxa barplot --i-table ./table.qza --i-taxonomy ./taxonomy.qza --m-metadata-file ../vineyards_metadata_ITS.tsv --o-visualization barplots_vineyard.tsv

qiime tools export --input-path barplots_vineyard.tsv.qzv --output-path barplots

echo "taxa done"

qiime taxa filter-table --i-table ./table.qza --i-taxonomy ./taxonomy.qza --p-exclude "cyano" --p-mode contains --o-filtered-table ./table_filtered.qza

echo "fitlering 1 done"

qiime phylogeny filter-tree --i-tree ./rooted_tree.qza --i-table ./denoised_asv_table_filtered.qza --o-filtered-tree ./rooted_tree_filtered.qza

echo "filtering done"

echo "script is done!"










